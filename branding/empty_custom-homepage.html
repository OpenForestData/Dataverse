<div class="main-page">
    <div class="main-search">
        <input class="main-page-search"/>
    </div>

    <div class="slider">

    </div>

    <div class="add-data">

    </div>

    <div class="search-by-topic">

    </div>
</div>


<script type="text/javascript">
    //<![CDATA[

    //switch baseUrl to point to a different server than the local box
    var oldBaseUrl = "";
    var getHostWithoutPort = location.protocol + '//' + location.hostname; // without port
    var baseUrl = window.location.origin; // protocol + ip + host
    console.log('main page adress: ', window.location.origin);

    // NOTE: REMOVED THUMBNAILS
    // var thumbBaseURL = baseUrl + "/api/datasets/:persistentId/thumbnail" + "?persistentId=";
    var metricBaseUrl = baseUrl + "/api/info/metrics/";
    var simpleCatSearch = baseUrl + "/api/search?q=*&type=dataset&sort=dateSort&order=desc&fq=categoryOfDataverse:";

    function writeRecentDatasetsInDataverses(fqString, resultCount, elm) {
        $.get(simpleCatSearch + fqString + "&per_page=" + resultCount, function(jData) {
            var resultHtml = "";
            jData.data.items.forEach(function(item) {
                var options = {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                };
                var date = new Date(item.published_at).toLocaleString('en-US', options);
                resultHtml += "<div class=\"hmpg-recent-block clearfix\">";
                // NOTE: REMOVED THUMBNAILS
                // resultHtml += "<div class=\"col-xs-2 text-center hmpg-recent-thumb\"><a href=\"/dataset.xhtml?persistentId=" + item.global_id + "\">";
                // resultHtml += "<object data=\"" + thumbBaseURL + item.global_id + "\" type=\"image/png\"/><span class=\"icon-dataset\"></span></object>";
                // resultHtml += "</a></div>";
                // NOTE: REMOVED THUMBNAILS... in next line, change grid layout class to `col-xs-9 col-md-10`
                resultHtml += "<div class=\"col-xs-12 hmpg-recent-metadata\"><p><a href=\"/dataset.xhtml?persistentId=" + item.global_id + "\">" + item.name + "</a></p><p class=\"small text-muted\"><a href=\"/dataverse/" + item.identifier_of_dataverse + "\" class=\"highlightBold\">" + item.name_of_dataverse + "</a> " + date + "</p></div>";
                resultHtml += "</div>";
            });
            document.getElementById(elm).innerHTML = resultHtml;
        });
    }

    //For metrics that return simple json with a count
    //Can take a single element or an array of elements
    function queryMetricSimple(metricRelPath, month, elm) {
        $.get(metricBaseUrl + metricRelPath + month, function(jData) {
            var resultCount = jData.data.count;
            if (Array.isArray(elm)) {
                elm.forEach(function(e) {
                    document.getElementById(e).innerHTML = resultCount.toLocaleString('en');
                });
            } else {
                document.getElementById(elm).innerHTML = resultCount.toLocaleString('en');
            }
        });
    }

    function queryMetricSearch(metricRelPath, month) {
        $.get(metricBaseUrl + metricRelPath + month, function(jData) {
            var resultCount = jData.data.count;
            var roundedDatasetCount = Math.floor(resultCount / 100) * 100;
            var dynamicSearchPlaceholder = "Szukaj pośród " + roundedDatasetCount.toLocaleString('en') + " zbiorów danych...";
            $("#inputDataverseSearch").attr({
                "placeholder": dynamicSearchPlaceholder
            });
        });
    }

    function querySubjectDataverseDataset(elm) {
        var dvArray = [];
        var fullArray = [];
        $.get(metricBaseUrl + "dataverses/bySubject", function(jData) {
            jData.data.forEach(function(item) {
                if (item.subject !== "N/A" && item.subject !== "Other") {
                    dvArray.push([item.subject, item.count]);
                }
            });
            $.get(metricBaseUrl + "datasets/bySubject?dataLocation=all", function(jData) {
                var resultHtml = "";
                jData.data.forEach(function(item) {
                    if (item.subject !== "N/A" && item.subject !== "Other") {
                        var dvCount = 0;
                        for (var dvi = 0; dvi < dvArray.length; dvi++) {
                            if (item.subject === dvArray[dvi][0]) {
                                dvCount = dvArray[dvi][1];
                                break;
                            }
                        }
                        fullArray.push([item.subject, (item.count + dvCount - 1).toLocaleString('en')]); //subtract 1 to remove root dv from counts
                    }
                });
                fullArray.sort();
                fullArray.forEach(function(subject) {
                    // NOTE: The alias of the root dataverse will need to be configured in this URL 
                    resultHtml += "<p class=\"browse-subjects\"><a href=\"/dataverse/root?q=&fq0=subject_ss%3A%22" + subject[0] + "%22&types=dataverses%3Adatasets&sort=dateSort&order=desc\">" + subject[0] + "</a> <span class=\"text-muted\">" + subject[1] + "</span></p>";
                });
                document.getElementById(elm).innerHTML = resultHtml;
            });
        });
    }

    // queryMetricSimple("datasets", "?dataLocation=all", ["headAllTimeAllDatasetsValue", "activityAllTimeAllDatasetsValue"]);
    // queryMetricSimple("downloads", "", ["headAllTimeAllDownloadsValue", "activityAllTimeAllDownloadsValue"]);
    // queryMetricSimple("dataverses", "", "headAllTimeAllDataversesValue");

    // writeRecentDatasetsInDataverses("(Journal)", 3, "journals");
    // writeRecentDatasetsInDataverses("(\"Research+Project\"%20OR%20Researcher%20OR%20\"Research+Group\")", 6, "researchers");

    // queryMetricSimple("datasets/pastDays", "/30?dataLocation=all", "activity30DaysAllDatasetsValue");
    // queryMetricSimple("datasets", "?dataLocation=local", "activityAllTimeDepositedDatasetsValue");
    // queryMetricSimple("datasets/pastDays", "/30?dataLocation=local", "activity30DaysDepositedDatasetsValue");
    // queryMetricSimple("datasets", "?dataLocation=remote", "activityAllTimeHarvestedDatasetsValue");
    // queryMetricSimple("datasets/pastDays", "/30?dataLocation=remote", "activity30DaysHarvestedDatasetsValue");

    // queryMetricSimple("downloads/pastDays", "/30", "activity30DaysAllDownloadsValue");
    // queryMetricSimple("files", "", "activityAllTimeDepositedFilesValue");
    // queryMetricSimple("files/pastDays", "/30", "activity30DaysDepositedFilesValue");

    // querySubjectDataverseDataset("dataversesBySubject");
    // queryMetricSearch("datasets", "?dataLocation=all");
    //]]>
</script>